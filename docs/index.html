<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QFix Mapping Documentation</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; color: #1a1a1a; background: #f8f9fa; line-height: 1.6; }

    .header { background: #1a1a1a; color: #fff; padding: 24px 32px; }
    .header h1 { font-size: 22px; font-weight: 600; }
    .header p { font-size: 14px; color: #aaa; margin-top: 4px; }

    .container { max-width: 900px; margin: 0 auto; padding: 24px 16px; }

    .card { background: #fff; border-radius: 8px; padding: 24px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .card h2 { font-size: 18px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #f0f0f0; }
    .card h3 { font-size: 15px; margin: 16px 0 8px; color: #555; }

    /* Verify form */
    .verify-form { display: flex; gap: 8px; margin-bottom: 16px; }
    .verify-form input {
      flex: 1; padding: 10px 14px; border: 2px solid #e0e0e0; border-radius: 6px;
      font-size: 15px; outline: none; transition: border-color 0.2s;
    }
    .verify-form input:focus { border-color: #1a1a1a; }
    .verify-form button {
      padding: 10px 24px; background: #1a1a1a; color: #fff; border: none;
      border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;
    }
    .verify-form button:hover { background: #333; }

    .verify-result { display: none; }
    .verify-result.active { display: block; }

    .step { display: flex; align-items: flex-start; gap: 12px; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
    .step:last-child { border-bottom: none; }
    .step-num {
      width: 28px; height: 28px; border-radius: 50%; background: #1a1a1a; color: #fff;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px; font-weight: 700; flex-shrink: 0;
    }
    .step-num.ok { background: #22c55e; }
    .step-num.fail { background: #ef4444; }
    .step-body { flex: 1; }
    .step-label { font-size: 13px; color: #888; }
    .step-value { font-size: 15px; font-weight: 500; }
    .step-detail { font-size: 13px; color: #666; margin-top: 2px; }

    .service-links { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
    .service-link {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 16px; background: #1a1a1a; color: #fff;
      border-radius: 6px; font-size: 13px; font-weight: 600;
      text-decoration: none; transition: background 0.2s;
    }
    .service-link:hover { background: #333; }
    .service-link.disabled { background: #ccc; pointer-events: none; }

    .product-info { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 14px; }
    .product-info dt { color: #888; }
    .product-info dd { font-weight: 500; word-break: break-word; }
    @media (max-width: 600px) { .product-info { grid-template-columns: 1fr; } }

    .error-msg { color: #ef4444; font-weight: 500; padding: 12px; background: #fef2f2; border-radius: 6px; }

    /* How it works */
    .flow { display: flex; flex-direction: column; gap: 0; }
    .flow-step { display: flex; gap: 14px; padding: 14px 0; }
    .flow-icon {
      width: 36px; height: 36px; border-radius: 50%; background: #f0f0f0;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; flex-shrink: 0;
    }
    .flow-arrow { text-align: center; color: #ccc; font-size: 20px; padding: 0 0 0 12px; }
    .flow-text h4 { font-size: 14px; font-weight: 600; }
    .flow-text p { font-size: 13px; color: #666; }

    /* Coverage table */
    .coverage-table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .coverage-table th { text-align: left; padding: 8px; border-bottom: 2px solid #e0e0e0; font-weight: 600; }
    .coverage-table td { padding: 8px; border-bottom: 1px solid #f0f0f0; }
    .coverage-bar { height: 8px; border-radius: 4px; background: #e0e0e0; overflow: hidden; min-width: 100px; }
    .coverage-fill { height: 100%; border-radius: 4px; background: #22c55e; }

    /* Mapping tables */
    details { margin: 8px 0; }
    details summary { cursor: pointer; font-weight: 600; font-size: 14px; padding: 8px 0; color: #333; }
    details summary:hover { color: #1a1a1a; }
    .map-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 8px; }
    .map-table th { text-align: left; padding: 6px 8px; background: #f8f9fa; border-bottom: 2px solid #e0e0e0; font-weight: 600; }
    .map-table td { padding: 5px 8px; border-bottom: 1px solid #f0f0f0; }
    .map-table tr:hover { background: #f8f9fa; }
    .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
    .tag-green { background: #dcfce7; color: #166534; }
    .tag-yellow { background: #fef9c3; color: #854d0e; }
    .tag-red { background: #fee2e2; color: #991b1b; }
    .tag-gray { background: #f3f4f6; color: #4b5563; }

    /* Rankings */
    .ranking-group { margin-bottom: 16px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; }
    .ranking-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 14px; background: #f8f9fa; cursor: pointer; user-select: none;
    }
    .ranking-header:hover { background: #f0f0f0; }
    .ranking-header h4 { font-size: 14px; font-weight: 600; margin: 0; }
    .ranking-header .rh-meta { font-size: 12px; color: #888; }
    .ranking-header .rh-arrow { color: #aaa; transition: transform 0.2s; }
    .ranking-header.open .rh-arrow { transform: rotate(90deg); }
    .ranking-body { display: none; padding: 0 14px 14px; }
    .ranking-body.open { display: block; }
    .ranking-material { margin-top: 10px; padding: 10px; background: #fafafa; border-radius: 6px; }
    .ranking-material-label { font-size: 12px; font-weight: 700; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
    .ranking-svc { margin-bottom: 8px; }
    .ranking-svc-label { font-size: 12px; font-weight: 700; color: #1a1a1a; margin-bottom: 4px; }
    .ranking-pills { display: flex; flex-wrap: wrap; gap: 4px; }
    .ranking-pill {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 3px 10px; background: #fff; border: 1px solid #e0e0e0;
      border-radius: 14px; font-size: 12px; white-space: nowrap;
    }
    .ranking-pill-id { color: #aaa; font-size: 11px; }
    .ranking-pill-price { color: #888; font-size: 11px; }

    /* Category drilldown */
    .cat-link { cursor: pointer; color: #2563eb; text-decoration: underline; }
    .cat-link:hover { color: #1d4ed8; }
    .drilldown-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.4); z-index: 1000; justify-content: center; align-items: center;
    }
    .drilldown-overlay.open { display: flex; }
    .drilldown-modal {
      background: #fff; border-radius: 12px; padding: 20px 24px; max-width: 900px; width: 95%;
      max-height: 80vh; overflow-y: auto; box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    }
    .drilldown-modal h3 { margin: 0 0 4px; font-size: 16px; }
    .drilldown-modal .dm-sub { font-size: 13px; color: #666; margin-bottom: 12px; }
    .drilldown-modal table { width: 100%; }
    .drilldown-close { float: right; cursor: pointer; font-size: 20px; color: #aaa; background: none; border: none; }
    .drilldown-close:hover { color: #333; }
  </style>
</head>
<body>

<div class="header">
  <h1>QFix Mapping Documentation</h1>
  <p>How product data is mapped to QFix repair booking categories</p>
</div>

<div class="container">

  <!-- Verify -->
  <div class="card">
    <h2>Verify a Product Mapping</h2>
    <p style="font-size:14px; color:#666; margin-bottom:12px;">Enter a product ID to see exactly how it gets mapped to a QFix repair category.</p>
    <div class="verify-form">
      <input type="text" id="productId" placeholder="Enter product ID (e.g. 530956)" />
      <button onclick="verify()">Verify</button>
    </div>
    <div id="verifyResult" class="verify-result"></div>
  </div>

  <!-- How it works -->
  <div class="card">
    <h2>How the Mapping Works</h2>
    <p style="font-size:14px; color:#666; margin-bottom:16px;">
      Each product in the database has a <strong>clothing type</strong> (e.g. "Jackor &amp; rockar") and a
      <strong>material composition</strong> (e.g. "99% Bomull, 1% Elastan"). The mapping system translates
      these into QFix repair categories so customers can book the right repair service.
    </p>

    <div class="flow">
      <div class="flow-step">
        <div class="flow-icon">1</div>
        <div class="flow-text">
          <h4>Identify Clothing Type</h4>
          <p>Each product's scraped Swedish category (e.g. "Jackor &amp; rockar &gt; Varjackor") is translated
             into a QFix clothing type (e.g. "Jacket"). The mapper uses four inputs:</p>
          <ul style="font-size:13px; margin:4px 0 8px 20px; color:#444;">
            <li><strong>clothing_type</strong> &mdash; the scraped category string</li>
            <li><strong>brand</strong> &mdash; which brand the product belongs to</li>
            <li><strong>product_name</strong> &mdash; the product's name/title</li>
            <li><strong>description</strong> &mdash; the product's description text</li>
          </ul>
          <p>The category is first <strong>normalized</strong>: split on "&gt;" into segments, lowercased, and
             gender prefixes (dam, herr, barn, flicka, pojke&hellip;) are stripped. For example,
             "Dam &gt; Jackor &amp; rockar &gt; Varjackor" becomes <code style="background:#f0f0f0; padding:1px 4px; border-radius:3px; font-size:12px;">["jackor &amp; rockar", "varjackor"]</code>.</p>
          <p style="margin-top:8px;">The mapper then tries four strategies <strong>in priority order</strong>, returning the first match:</p>
          <ol style="font-size:13px; margin:4px 0 0 20px; color:#444;">
            <li style="margin-bottom:6px;"><strong>Brand-specific exact override</strong> &mdash; A per-brand dictionary that overrides the
              generic mapping for specific clothing types. For example, if KappAhl's "Jacket" should map differently
              than the default, an entry in <code style="background:#f0f0f0; padding:1px 4px; border-radius:3px; font-size:12px;">BRAND_CLOTHING_TYPE_OVERRIDES</code> takes precedence.</li>
            <li style="margin-bottom:6px;"><strong>Brand-specific sub-mappings</strong> &mdash; For categories that need finer-grained
              classification, brand-specific logic examines the full category path and product name/description.
              <br><em>Hierarchical categories</em> (KappAhl, Gina Tricot) use sub-path segments:
              e.g. "Badkl&auml;der &gt; Bikini" &rarr; Bikini, "Jackor &amp; rockar &gt; V&auml;star" &rarr; Unlined Jacket/Vest.
              <br><em>Flat categories</em> (Lindex) combine the <strong>product name</strong> and <strong>description</strong>
              as keyword signals to disambiguate: e.g. a "badklader" product named "Bikiniset" maps to Bikini instead of Swimsuit;
              a "trojor koftor" product with "sweatshirt" in the name maps to Sweatshirt/Hoodie instead of Knitted Jumper.</li>
            <li style="margin-bottom:6px;"><strong>Generic mapping table</strong> &mdash; A table of ~460 Swedish category names mapped
              to QFix clothing types. Multi-level categories are matched segment by segment (first the full path,
              then just the first segment). This handles the vast majority of products.</li>
            <li style="margin-bottom:6px;"><strong>Keyword fallback</strong> &mdash; If no direct match is found, individual words from
              the category string are checked against known clothing keywords (e.g. "jacka" &rarr; Jacket,
              "byxor" &rarr; Trousers). This catches edge cases and new categories not yet in the mapping table.</li>
          </ol>

          <h4 style="margin-top:16px; font-size:14px;">Brand-Specific Sub-Mapping Rules</h4>
          <p style="font-size:13px; color:#666; margin-bottom:8px;">Click each brand to expand its rules. Categories use <code style="background:#f0f0f0; padding:1px 4px; border-radius:3px; font-size:12px;">&gt;</code> for sub-paths.
             Rules marked with <span style="color:#e67e22;">&#9733;</span> use product name/description keywords for disambiguation.</p>

          <!-- KappAhl rules -->
          <details style="margin-bottom:8px;">
            <summary style="cursor:pointer; font-weight:bold; font-size:14px; padding:4px 0;">KappAhl</summary>
            <table style="font-size:13px; margin:8px 0; border-collapse:collapse; width:100%;">
              <thead><tr style="background:#f8f9fa;">
                <th style="text-align:left; padding:4px 8px; border-bottom:2px solid #e0e0e0;">Category</th>
                <th style="text-align:left; padding:4px 8px; border-bottom:2px solid #e0e0e0;">Sub-path / Condition</th>
                <th style="text-align:left; padding:4px 8px; border-bottom:2px solid #e0e0e0;">Maps to</th>
              </tr></thead>
              <tbody>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Badkl&auml;der</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Bikini</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Bikini</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Badkl&auml;der</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; (other)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Swimsuit</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Ytterkl&auml;der</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Regnbyxor / Skalbyxor / Skidbyxor</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Trousers</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Ytterkl&auml;der</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Overaller</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Overall</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Ytterkl&auml;der</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; V&auml;star</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Unlined Jacket / Vest</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Ytterkl&auml;der</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; (other)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Jacket</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Jackor &amp; rockar</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; V&auml;star</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Unlined Jacket / Vest</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Jackor &amp; rockar</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; (other)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Jacket</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Loungewear</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Underdelar</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Trousers</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Loungewear</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Underst&auml;ll</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Midlayer</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Loungewear</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; (other sub-path)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Sweatshirt / Hoodie</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Loungewear</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">(no sub-path)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Trousers / Shorts</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Skor &amp; tofflor</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Tofflor / Slippers</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Other shoes</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Skor &amp; tofflor</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; (other)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Sneakers</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Tr&ouml;jor &amp; cardigans</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Hoodies / Sweatshirt</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Sweatshirt / Hoodie</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Tr&ouml;jor &amp; cardigans</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Stickade v&auml;star / V&auml;star</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Unlined Jacket / Vest</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Tr&ouml;jor &amp; cardigans</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; (other)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Knitted Jumper</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Tr&auml;ningskl&auml;der</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Tights / Cykelbyxor / Leggings</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Trousers</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Tr&auml;ningskl&auml;der</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Shorts / Cykelshorts</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Trousers / Shorts</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Tr&auml;ningskl&auml;der</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Linne / Topp / Sport-BH</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Top / T-shirt</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Tr&auml;ningskl&auml;der</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; (other)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Sweatshirt / Hoodie</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Mammakl&auml;der</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Toppar / Tr&ouml;jor / Blusar</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Top / T-shirt</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Mammakl&auml;der</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Kl&auml;nningar</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Skirt / Dress</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Mammakl&auml;der</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; (other)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Trousers</td></tr>
              </tbody>
            </table>
          </details>

          <!-- Gina Tricot rules -->
          <details style="margin-bottom:8px;">
            <summary style="cursor:pointer; font-weight:bold; font-size:14px; padding:4px 0;">Gina Tricot</summary>
            <table style="font-size:13px; margin:8px 0; border-collapse:collapse; width:100%;">
              <thead><tr style="background:#f8f9fa;">
                <th style="text-align:left; padding:4px 8px; border-bottom:2px solid #e0e0e0;">Category</th>
                <th style="text-align:left; padding:4px 8px; border-bottom:2px solid #e0e0e0;">Sub-path / Condition</th>
                <th style="text-align:left; padding:4px 8px; border-bottom:2px solid #e0e0e0;">Maps to</th>
              </tr></thead>
              <tbody>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Badklader</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Bikini</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Bikini</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Badklader</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; (other)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Swimsuit</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Skor</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Boots</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Boots</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Skor</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; H&ouml;gklackade / Klack</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">High heels</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Skor</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Sandaler</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Sandals</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Skor</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Sneakers</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Sneakers</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Skor</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Tofflor / Ballerina</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Other shoes</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Skor</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">(no sub-path)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Other shoes</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Festklader</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Byxor</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Trousers</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Festklader</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; (other)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Skirt / Dress</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">M&ouml;ssor &amp; vantar</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Caps / Keps</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Cap</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">M&ouml;ssor &amp; vantar</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; (other)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Hat</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Coats &amp; Jackets</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; V&auml;star</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Unlined Jacket / Vest</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Coats &amp; Jackets</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Kavajer</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Suit</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Coats &amp; Jackets</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; (other)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Jacket</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Knitted</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Accessories</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Scarf / Shawl</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Knitted</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; V&auml;star</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Unlined Jacket / Vest</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Knitted</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; (other)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Knitted Jumper</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Jeans</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Shorts</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Trousers / Shorts</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Jeans</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; (other)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Trousers</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Basplagg</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Shorts / Biker / Cykel</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Trousers / Shorts</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Basplagg</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; (other)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Top / T-shirt</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Tr&ouml;jor</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Hoodies / Collegetr&ouml;jor</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Sweatshirt / Hoodie</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Tr&ouml;jor</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; V&auml;star</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Unlined Jacket / Vest</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Tr&ouml;jor</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; (other)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Knitted Jumper</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Loungewear</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">(any)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Other</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Tr&auml;ningskl&auml;der</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; Pilates / Yoga</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Top / T-shirt</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Tr&auml;ningskl&auml;der</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">&gt; (other)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Sweatshirt / Hoodie</td></tr>
              </tbody>
            </table>
          </details>

          <!-- Lindex rules -->
          <details style="margin-bottom:8px;">
            <summary style="cursor:pointer; font-weight:bold; font-size:14px; padding:4px 0;">Lindex <span style="font-weight:normal; font-size:12px; color:#e67e22;">&#9733; uses product name/description</span></summary>
            <table style="font-size:13px; margin:8px 0; border-collapse:collapse; width:100%;">
              <thead><tr style="background:#f8f9fa;">
                <th style="text-align:left; padding:4px 8px; border-bottom:2px solid #e0e0e0;">Category</th>
                <th style="text-align:left; padding:4px 8px; border-bottom:2px solid #e0e0e0;">Product name/description keyword</th>
                <th style="text-align:left; padding:4px 8px; border-bottom:2px solid #e0e0e0;">Maps to</th>
              </tr></thead>
              <tbody>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">badklader / badklader uv</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">contains "bikini"</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Bikini</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">badklader / badklader uv</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">(default)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Swimsuit</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">kavajer tunna jackor</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">contains "kavaj" or "blazer"</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Suit</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">kavajer tunna jackor</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">(default)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Jacket</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">performancewear</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">contains "byxor" / "byxa"</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Trousers</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">performancewear</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">contains "overall"</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Overall</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">performancewear</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">contains "vantar" / "tumvantar"</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Gloves</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">performancewear</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">contains "m&ouml;ssa"</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Hat</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">performancewear</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">(default)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Jacket</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">traningsklader</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">contains "baddr&auml;kt"</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Swimsuit</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">traningsklader</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">(default)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Underwear</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">trojor koftor / trojor cardigans</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">contains "sweatshirt" / "hoodie" / "college"</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Sweatshirt / Hoodie</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">trojor koftor / trojor cardigans</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">(default)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Knitted Jumper</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">linnen</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">(always)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Top / T-shirt</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">klimakterieklader</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">(always)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Top / T-shirt</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">mammaklader</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">contains "shorts" / "cykelbyxa"</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Trousers / Shorts</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">mammaklader</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">contains "jeans" / "byxor" / "leggings"</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Trousers</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">mammaklader</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">contains "kl&auml;nning"</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Skirt / Dress</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">mammaklader</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">contains "topp" / "linne" / "t-shirt" / "tr&ouml;ja"</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Top / T-shirt</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">mammaklader</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">(default)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Other</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">nyfodd</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">contains "body" / "omlottbody"</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Underwear</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">nyfodd</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">contains "kl&auml;nning"</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Skirt / Dress</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">nyfodd</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">contains "byxor" / "leggings" / "mjukisbyxor"</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Trousers</td></tr>
                <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">nyfodd</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">(default)</td>
                  <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Other</td></tr>
              </tbody>
            </table>
          </details>

          <!-- Eton & Nudie -->
          <details style="margin-bottom:8px;">
            <summary style="cursor:pointer; font-weight:bold; font-size:14px; padding:4px 0;">Eton &amp; Nudie Jeans</summary>
            <p style="font-size:13px; color:#666; margin:8px 0;">No brand-specific sub-mappings needed. All categories map correctly via the generic mapping table.</p>
          </details>
        </div>
      </div>
      <div class="flow-arrow">&#8595;</div>

      <div class="flow-step">
        <div class="flow-icon">2</div>
        <div class="flow-text">
          <h4>Identify Material</h4>
          <p>The material composition string is parsed to extract individual materials and their percentages
             (e.g. "99% Bomull" = Cotton 99%). The dominant material (highest percentage) determines the
             QFix material category: Standard textile, Linen/Wool, Cashmere, Silk, Leather/Suede, Down, or Fur.</p>
        </div>
      </div>
      <div class="flow-arrow">&#8595;</div>

      <div class="flow-step">
        <div class="flow-icon">3</div>
        <div class="flow-text">
          <h4>Resolve Gender-Specific IDs</h4>
          <p>The same clothing type (e.g. "Jacket") has different QFix IDs for Men's, Women's, and Children's clothing.
             The product's category (dam/herr/barn) determines which ID to use.
             The material also gets an ID that depends on the clothing type (shoes use different IDs than clothing).</p>
        </div>
      </div>
      <div class="flow-arrow">&#8595;</div>

      <div class="flow-step">
        <div class="flow-icon">4</div>
        <div class="flow-text">
          <h4>Select Top 5 Service Actions</h4>
          <p>Each clothing type + material combination in the QFix catalog has many available service actions
             (often 20+ per category). AI has pre-ranked the <strong>top 10</strong> most relevant actions per service category
             (repair, adjustment, care, other) for all 259 combinations. These are stored in the database.</p>
          <p style="margin-top:4px; font-size:13px; color:#666;"><strong>Backfill mechanism:</strong> The system stores 10 actions (not 5) so that when
             exclusion rules (Step 6) remove irrelevant actions, the remaining slots are filled from positions 6&ndash;10
             instead of leaving gaps. For example, a vest has 10 ranked adjustments &rarr; "Shorten sleeves" and "Lengthen sleeves"
             are excluded &rarr; 8 remain &rarr; top 5 selected (positions 6&ndash;7 backfill the gaps left by the 2 excluded actions).
             The final 5 are passed as <code>variants_id</code> in the redirect URL to pre-select them on QFix.</p>
        </div>
      </div>
      <div class="flow-arrow">&#8595;</div>

      <div class="flow-step">
        <div class="flow-icon">5</div>
        <div class="flow-text">
          <h4>Product-Specific Action Boost (Keyword Injection)</h4>
          <p>The generic top 5 is based on clothing type only, but individual products may have specific
             features that make certain actions more relevant. The product name and description are scanned
             for keywords, and matching actions are merged with the AI-ranked top 5 using a <strong>score-based ranking</strong>.</p>
          <p style="margin-top:4px; font-size:13px; color:#666;"><strong>Smart variant selection:</strong> Each keyword rule has multiple action variants
             (e.g., "Replace button", "Replace jeans button", "Replace snap button"). Instead of injecting all variants,
             the system uses <strong>sub-keyword matching</strong> to pick the most relevant one for each product.
             For example, "Replace jeans button" only triggers when "jeans" or "denim" appears in the product text.
             At most <strong>2 actions per rule</strong> are injected: the best sub-keyword match plus the generic default.</p>
          <div id="keywordStatsTable" style="font-size:13px; color:#aaa; margin:8px 0;">Loading keyword stats...</div>
          <p style="margin-top:8px;"><strong>How the merge works:</strong> The selected keyword actions (max 2 per rule) are scored and merged
             with the AI-ranked top 5:</p>
          <table style="font-size:13px; margin:8px 0; border-collapse:collapse;">
            <thead><tr style="background:#f8f9fa;">
              <th style="text-align:left; padding:4px 8px; border-bottom:2px solid #e0e0e0;">Source</th>
              <th style="text-align:center; padding:4px 8px; border-bottom:2px solid #e0e0e0;">#1</th>
              <th style="text-align:center; padding:4px 8px; border-bottom:2px solid #e0e0e0;">#2</th>
              <th style="text-align:center; padding:4px 8px; border-bottom:2px solid #e0e0e0;">#3</th>
              <th style="text-align:center; padding:4px 8px; border-bottom:2px solid #e0e0e0;">#4</th>
              <th style="text-align:center; padding:4px 8px; border-bottom:2px solid #e0e0e0;">#5</th>
              <th style="text-align:center; padding:4px 8px; border-bottom:2px solid #e0e0e0; color:#999;">#6</th>
              <th style="text-align:center; padding:4px 8px; border-bottom:2px solid #e0e0e0; color:#999;">#7</th>
              <th style="text-align:center; padding:4px 8px; border-bottom:2px solid #e0e0e0; color:#999;">#8</th>
              <th style="text-align:center; padding:4px 8px; border-bottom:2px solid #e0e0e0; color:#999;">#9</th>
              <th style="text-align:center; padding:4px 8px; border-bottom:2px solid #e0e0e0; color:#999;">#10</th>
            </tr></thead>
            <tbody>
              <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">AI-ranked (stored)</td>
                <td style="text-align:center; padding:3px 8px; border-bottom:1px solid #f0f0f0;"><strong>10</strong></td>
                <td style="text-align:center; padding:3px 8px; border-bottom:1px solid #f0f0f0;"><strong>9</strong></td>
                <td style="text-align:center; padding:3px 8px; border-bottom:1px solid #f0f0f0;">8</td>
                <td style="text-align:center; padding:3px 8px; border-bottom:1px solid #f0f0f0;">7</td>
                <td style="text-align:center; padding:3px 8px; border-bottom:1px solid #f0f0f0;">6</td>
                <td style="text-align:center; padding:3px 8px; border-bottom:1px solid #f0f0f0; color:#999;">5</td>
                <td style="text-align:center; padding:3px 8px; border-bottom:1px solid #f0f0f0; color:#999;">4</td>
                <td style="text-align:center; padding:3px 8px; border-bottom:1px solid #f0f0f0; color:#999;">3</td>
                <td style="text-align:center; padding:3px 8px; border-bottom:1px solid #f0f0f0; color:#999;">2</td>
                <td style="text-align:center; padding:3px 8px; border-bottom:1px solid #f0f0f0; color:#999;">1</td></tr>
              <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Keyword-injected (max 2 per rule)</td>
                <td style="text-align:center; padding:3px 8px; border-bottom:1px solid #f0f0f0;"><strong>7</strong></td>
                <td style="text-align:center; padding:3px 8px; border-bottom:1px solid #f0f0f0;">5</td>
                <td style="text-align:center; padding:3px 8px; border-bottom:1px solid #f0f0f0;" colspan="9"></td></tr>
            </tbody>
          </table>
          <p style="margin-top:4px; font-size:13px; color:#666;">Positions #6&ndash;#10 (greyed out) are stored for backfill but normally trimmed away.
             They only surface when exclusion rules remove higher-ranked actions.</p>
          <p style="margin-top:4px; font-size:13px; color:#666;"><strong>Exclusion check:</strong> Keyword-injected actions are also checked against
             the exclusion rules (Step 6). If a product triggers both a keyword injection and an exclusion for the same action,
             the exclusion wins. For example, leggings with "dragkedja" in the description will NOT get "Replace zipper" injected
             because the leggings exclusion rule blocks it.</p>
          <p style="margin-top:8px;"><strong>Example:</strong> "Stickad cardigan med dragkedja" (knitted cardigan with zipper) &mdash; the merged repair list:</p>
          <ol style="font-size:13px; margin:4px 0 0 20px; color:#444;">
            <li><strong>Repair hole</strong> <span style="color:#aaa;">(AI #1, score 10)</span></li>
            <li><strong>Repair wear</strong> <span style="color:#aaa;">(AI #2, score 8)</span></li>
            <li><strong>Replace zipper</strong> <span style="color:#aaa;">(keyword default, score 7)</span></li>
            <li><strong>Repair seam</strong> <span style="color:#aaa;">(AI #3, score 6)</span></li>
            <li><strong>Replace button</strong> <span style="color:#aaa;">(AI #4, score 4)</span></li>
          </ol>
          <p style="margin-top:4px; font-size:13px; color:#666;">Only 1 zipper action injected (the generic default). Important actions like "Repair hole" and "Repair seam" stay in the top 5.</p>
          <p style="margin-top:8px;"><strong>Example 2:</strong> "Jeansjacka med knappar" (jeans jacket with buttons) &mdash; sub-keyword "jeans" matches "Replace jeans button":</p>
          <ol style="font-size:13px; margin:4px 0 0 20px; color:#444;">
            <li><strong>Replace main zipper</strong> <span style="color:#aaa;">(AI #1, score 10)</span></li>
            <li><strong>Repair tear</strong> <span style="color:#aaa;">(AI #2, score 8)</span></li>
            <li><strong>Replace jeans button</strong> <span style="color:#aaa;">(keyword sub-match, score 7)</span></li>
            <li><strong>Repair seam</strong> <span style="color:#aaa;">(AI #3, score 6)</span></li>
            <li><strong>Replace button</strong> <span style="color:#aaa;">(keyword default, score 5)</span></li>
          </ol>
          <p style="margin-top:4px; font-size:13px; color:#666;">The sub-keyword system picks "Replace jeans button" specifically for jeans products,
             while a regular shirt with buttons would only get the generic "Replace button". Max 2 button actions instead of the previous 5.</p>
        </div>
      </div>

      <div class="flow-step">
        <div class="flow-icon">6</div>
        <div class="flow-text">
          <h4>Action Exclusion Rules</h4>
          <p>Some products are mapped to broad QFix categories (e.g., a vest mapped to "Suit") which include
             actions that don't apply. The system scans the product text for keywords and <strong>removes</strong> irrelevant actions:</p>
          <table style="font-size:13px; margin:8px 0; border-collapse:collapse; width:100%;">
            <thead><tr style="background:#f8f9fa;">
              <th style="text-align:left; padding:4px 8px; border-bottom:2px solid #e0e0e0;">Product keywords</th>
              <th style="text-align:left; padding:4px 8px; border-bottom:2px solid #e0e0e0;">Excluded actions</th>
              <th style="text-align:left; padding:4px 8px; border-bottom:2px solid #e0e0e0;">Category</th>
            </tr></thead>
            <tbody>
              <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">v√§st, vest, gilet, bodywarmer</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Shorten sleeves, Lengthen sleeves, Tapering legs, Shorten legs, Lengthen legs</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">adjustment</td></tr>
              <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">linne, singlet, tank top, √§rml√∂s, sleeveless, bandeau, tubtopp</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Shorten sleeves, Lengthen sleeves</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">adjustment</td></tr>
              <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">shorts</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Tapering legs</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">adjustment</td></tr>
              <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">kjol, skirt</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Shorten sleeves, Lengthen sleeves, Tapering legs</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">adjustment</td></tr>
              <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">badshorts, swim shorts, badbyxor</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Replace zipper, Replace main zipper, Replace zipper slider</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">repair</td></tr>
              <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">badshorts, swim shorts, badbyxor</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Narrow shoulder area, Shorten sleeves, Lengthen sleeves, Shorten length</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">adjustment</td></tr>
              <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">bikini, baddr√§kt, swimsuit, badedrakt</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Shorten sleeves, Lengthen sleeves, Tapering legs, Shorten length</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">adjustment</td></tr>
              <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">strumpor, socks, sockor, strumpa</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">All adjustment actions</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">adjustment</td></tr>
              <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">strumpbyxa, strumpbyxor, tights, pantyhose</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">All adjustment actions</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">adjustment</td></tr>
              <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">poncho</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Shorten sleeves, Lengthen sleeves</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">adjustment</td></tr>
              <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">cape</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Shorten sleeves, Lengthen sleeves</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">adjustment</td></tr>
              <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">leggings</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Tapering legs (adj), Replace zipper (repair)</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">both</td></tr>
              <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">bandeau, tubtopp, tube top, strapless</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Narrow shoulder area</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">adjustment</td></tr>
              <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">tr√§ningstights, cykelbyxa, cykelbyxor</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Sleeves, shoulders (adj), Replace zipper (repair)</td>
                <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">both</td></tr>
            </tbody>
          </table>
          <p style="margin-top:4px; font-size:13px; color:#666;"><strong>Note:</strong> Keywords are matched against product name, description, <em>and</em> the clothing type category
             field. This catches products where distinguishing keywords (e.g., "leggings", "strumpbyxor", "croptops")
             only appear in the category, not the product name.</p>
          <p style="margin-top:4px; font-size:13px; color:#666;"><strong>Processing order:</strong> Exclusions are applied <strong>before</strong> the final top 5 selection.
             The system has up to 10 AI-ranked actions per category. Exclusions filter the full pool of 10, then the best 5 are selected.
             This means excluded actions are replaced by lower-ranked ones (backfill) rather than leaving empty slots.</p>
          <p style="margin-top:4px; font-size:13px; color:#666;"><strong>Example:</strong> "V√§st i linnemix" (linen vest) is mapped to "Suit" which has 10 ranked adjustments.
             The exclusion rule removes "Shorten sleeves" (#3) and "Lengthen sleeves" (#6) &rarr; 8 remain &rarr;
             top 5 selected: "Take in waist", "Shorten length", "Take in sides", "Narrow shoulder area", "Take in the back".
             Positions #6&ndash;#7 ("Take in shoulders", "Expand waist") backfilled the gaps left by the excluded sleeve actions.</p>
        </div>
      </div>
      <div class="flow-arrow">&#8595;</div>

      <div class="flow-step">
        <div class="flow-icon">7</div>
        <div class="flow-text">
          <h4>Build QFix URL</h4>
          <p>The final redirect URL combines all resolved IDs from the previous steps:</p>
          <ul style="font-size:13px; margin:4px 0 8px 20px; color:#444;">
            <li><code style="background:#f0f0f0; padding:1px 4px; border-radius:3px; font-size:12px;">category_id</code> &mdash; the gender-specific clothing type ID (Step 3)</li>
            <li><code style="background:#f0f0f0; padding:1px 4px; border-radius:3px; font-size:12px;">material_id</code> &mdash; the material ID (Step 3)</li>
            <li><code style="background:#f0f0f0; padding:1px 4px; border-radius:3px; font-size:12px;">service_id</code> &mdash; which service type (repair, adjustment, care)</li>
            <li><code style="background:#f0f0f0; padding:1px 4px; border-radius:3px; font-size:12px;">variants_id</code> &mdash; the final top 5 action IDs after keyword injection and exclusion filtering (Steps 4&ndash;6)</li>
          </ul>
          <p>Example URL:<br>
             <code style="background:#f0f0f0; padding:2px 6px; border-radius:4px; font-size:13px;">
               https://kappahl.dev.qfixr.me/sv/?category_id=85&amp;material_id=69&amp;service_id=3&amp;variants_id=101,102,103,104,105
             </code></p>
          <p style="margin-top:4px; font-size:13px; color:#666;">This URL pre-selects the clothing type, material, service, and
             the most relevant actions for the specific product, so the customer lands directly on the right booking page.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Unmapped products -->
  <div class="card">
    <h2>What Happens When a Product Can't Be Mapped?</h2>
    <p style="font-size:14px; color:#666;">
      If the clothing type or material doesn't match any rule, the product is marked as <strong>unmapped</strong>.
      This happens for:
    </p>
    <ul style="font-size:14px; color:#666; margin:8px 0 0 20px;">
      <li>Non-repairable items (accessories, jewelry, sunglasses, bags without a category)</li>
      <li>New product categories the scrapers haven't seen before</li>
      <li>Material compositions that don't match any known pattern</li>
      <li>Products where the scraper didn't extract a clothing type (NULL category)</li>
    </ul>
    <p style="font-size:14px; color:#666; margin-top:8px;">
      Unmapped products can be reviewed at <a href="/unmapped" style="color:#1a1a1a;">/unmapped</a> and new mapping
      rules can be added via <a href="/remap" style="color:#1a1a1a;">/remap</a> (AI-assisted) or manually.
    </p>

    <h4 style="margin-top:16px; font-size:14px;">Why some brands have lower coverage</h4>
    <p style="font-size:13px; color:#666;">
      Coverage percentage reflects the share of <em>all scraped products</em> that have a QFix URL, not just clothing.
      Brands with large accessory catalogs will naturally show lower coverage because accessories
      (ties, pocket squares, cufflinks, belts, etc.) don't have QFix repair categories.
    </p>
    <table style="font-size:13px; margin:8px 0; border-collapse:collapse; width:100%;">
      <thead><tr style="background:#f8f9fa;">
        <th style="text-align:left; padding:4px 8px; border-bottom:2px solid #e0e0e0;">Brand</th>
        <th style="text-align:left; padding:4px 8px; border-bottom:2px solid #e0e0e0;">Main unmapped categories</th>
        <th style="text-align:left; padding:4px 8px; border-bottom:2px solid #e0e0e0;">Why</th>
      </tr></thead>
      <tbody>
        <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;"><strong>Eton</strong> (~53%)</td>
          <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Accessoarer (ties, pocket squares, cufflinks), products with no category</td>
          <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">~47% of Eton's catalog is accessories that QFix doesn't service. All actual clothing items are mapped correctly.</td></tr>
        <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;"><strong>Lindex</strong> (~56%)</td>
          <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Accessories, home textiles, beauty products</td>
          <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Lindex sells non-clothing items (candles, skincare, home d&eacute;cor) that are scraped but not repairable.</td></tr>
        <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;"><strong>Gina Tricot</strong> (~90%)</td>
          <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Accessories (jewellery, hair clips, bags)</td>
          <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Smaller share of non-clothing items.</td></tr>
        <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;"><strong>KappAhl</strong> (~93%)</td>
          <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Accessories, multi-packs</td>
          <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Mostly clothing. Small number of accessories and edge cases.</td></tr>
        <tr><td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;"><strong>Nudie Jeans</strong> (~98%)</td>
          <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">A few edge cases</td>
          <td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">Almost entirely clothing. Very few unmapped products.</td></tr>
      </tbody>
    </table>
    <p style="font-size:13px; color:#666; margin-top:4px;">
      <strong>Key takeaway:</strong> Low coverage does not mean broken mappings &mdash; it means the brand's catalog includes
      many non-clothing products. All actual clothing items across all brands are mapped correctly.
    </p>
  </div>

  <!-- Coverage -->
  <div class="card">
    <h2>Mapping Coverage</h2>
    <p style="font-size:14px; color:#666; margin-bottom:12px;">How many products per brand have a working QFix mapping.</p>
    <table class="coverage-table">
      <thead><tr><th>Brand</th><th>Total</th><th>Mapped</th><th>Unmapped</th><th>Coverage</th></tr></thead>
      <tbody id="coverageBody"><tr><td colspan="5" style="color:#aaa;">Loading...</td></tr></tbody>
    </table>
  </div>

  <!-- Mapping tables -->
  <div class="card">
    <h2>Mapping Rules Reference</h2>
    <p style="font-size:14px; color:#666; margin-bottom:12px;">These are the actual mapping tables used by the system.</p>

    <details>
      <summary>Valid QFix Clothing Types (88 types)</summary>
      <p style="font-size:13px; color:#666; margin:4px 0 8px;">These are the target clothing types in the QFix system. Each product is mapped to one of these.</p>
      <table class="map-table">
        <thead><tr><th>QFix Clothing Type</th><th>ID</th></tr></thead>
        <tbody id="clothingTypesBody"></tbody>
      </table>
    </details>

    <details>
      <summary>Material Categories</summary>
      <p style="font-size:13px; color:#666; margin:4px 0 8px;">Products are classified into one of these material categories based on their composition.</p>
      <table class="map-table">
        <thead><tr><th>QFix Material</th><th>Description</th></tr></thead>
        <tbody>
          <tr><td>Standard textile</td><td>Cotton, polyester, nylon, viscose, elastane, and most common fabrics</td></tr>
          <tr><td>Linen/Wool</td><td>Linen, wool, merino, alpaca, and blends where these dominate</td></tr>
          <tr><td>Cashmere</td><td>Cashmere and cashmere-dominant blends</td></tr>
          <tr><td>Silk</td><td>Silk and silk-dominant blends</td></tr>
          <tr><td>Leather/Suede</td><td>Leather, suede, and similar animal hides</td></tr>
          <tr><td>Down</td><td>Down-filled garments</td></tr>
          <tr><td>Fur</td><td>Fur garments</td></tr>
          <tr><td>Other/Unsure</td><td>Fallback when material can't be determined</td></tr>
        </tbody>
      </table>
    </details>

    <details>
      <summary>Unmapped Categories per Brand</summary>
      <p style="font-size:13px; color:#666; margin:4px 0 8px;">Product categories that can't be mapped to a QFix clothing type (accessories, non-clothing items, missing categories). These products won't get a QFix repair URL.</p>
      <div id="unmappedCategoriesContainer" style="font-size:13px; color:#aaa;">Loading...</div>
    </details>

    <details>
      <summary>QFix Types Missing Services</summary>
      <p style="font-size:13px; color:#666; margin:4px 0 8px;">Clothing types in the QFix catalog that have zero service actions defined (repair, adjustment, care, other).</p>
      <div id="missingServicesContainer" style="font-size:13px; color:#aaa;">Loading...</div>
    </details>

    <details>
      <summary>AI-Ranked Top 5 Actions per Category</summary>
      <p style="font-size:13px; color:#666; margin:4px 0 8px;">For each clothing type + material combination, AI has ranked the 5 most relevant service actions per service category.</p>
      <input type="text" id="rankingsFilter" placeholder="Filter by clothing type or material..." style="width:100%; padding:8px 12px; border:2px solid #e0e0e0; border-radius:6px; font-size:13px; margin-bottom:12px; outline:none;" />
      <div id="rankingsContainer" style="font-size:13px; color:#aaa;">Loading...</div>
    </details>

    <details>
      <summary>Swedish Clothing Type Mappings (~460 rules)</summary>
      <p style="font-size:13px; color:#666; margin:4px 0 8px;">How Swedish scraped categories map to QFix types. Showing mapped entries only.</p>
      <table class="map-table">
        <thead><tr><th>Swedish Category</th><th>QFix Type</th></tr></thead>
        <tbody id="clothingMapBody"></tbody>
      </table>
    </details>

    <details>
      <summary>Material Composition Mappings (~110 rules)</summary>
      <p style="font-size:13px; color:#666; margin:4px 0 8px;">How individual material names map to QFix material categories.</p>
      <table class="map-table">
        <thead><tr><th>Material Name</th><th>QFix Material</th></tr></thead>
        <tbody id="materialMapBody"></tbody>
      </table>
    </details>
  </div>

</div>

<script>
// Verify product
async function verify() {
  const pid = document.getElementById('productId').value.trim();
  if (!pid) return;

  const el = document.getElementById('verifyResult');
  el.className = 'verify-result active';
  el.innerHTML = '<p style="color:#888;">Loading...</p>';

  try {
    const res = await fetch('/docs/verify/' + encodeURIComponent(pid));
    const data = await res.json();

    if (data.error) {
      el.innerHTML = '<div class="error-msg">' + data.error + '</div>';
      return;
    }

    const p = data.product;
    const m = data.mapping;
    const svcs = data.services || [];

    let html = '<h3 style="margin-bottom:12px;">Product</h3>';
    html += '<dl class="product-info">';
    html += '<dt>Product ID</dt><dd>' + esc(p.product_id) + '</dd>';
    html += '<dt>Name</dt><dd>' + esc(p.product_name || '‚Äî') + '</dd>';
    html += '<dt>Brand</dt><dd>' + esc(p.brand || '‚Äî') + '</dd>';
    html += '<dt>Category</dt><dd>' + esc(p.category || '‚Äî') + '</dd>';
    html += '<dt>Clothing Type</dt><dd>' + esc(p.clothing_type || '‚Äî') + '</dd>';
    html += '<dt>Material</dt><dd>' + esc(p.material_composition || '‚Äî') + '</dd>';
    html += '</dl>';

    html += '<h3 style="margin:20px 0 12px;">Mapping Steps</h3>';

    // Step 1: Clothing type
    const ctOk = m.clothing_type_result != null;
    html += '<div class="step">';
    html += '<div class="step-num ' + (ctOk ? 'ok' : 'fail') + '">1</div>';
    html += '<div class="step-body">';
    html += '<div class="step-label">Clothing Type</div>';
    html += '<div class="step-value">' + esc(m.clothing_type_input || '(empty)') + ' &rarr; ';
    html += ctOk ? '<span class="tag tag-green">' + esc(m.clothing_type_result) + '</span>'
                 : '<span class="tag tag-red">No match</span>';
    html += '</div>';
    if (ctOk) html += '<div class="step-detail">QFix ID: ' + m.clothing_type_id + '</div>';
    html += '</div></div>';

    // Step 2: Material
    const matOk = m.material_result != null && m.material_result !== 'Other/Unsure';
    html += '<div class="step">';
    html += '<div class="step-num ' + (m.material_result ? 'ok' : 'fail') + '">2</div>';
    html += '<div class="step-body">';
    html += '<div class="step-label">Material</div>';
    html += '<div class="step-value">' + esc(m.material_input || '(empty)') + ' &rarr; ';
    html += m.material_result ? '<span class="tag ' + (matOk ? 'tag-green' : 'tag-yellow') + '">' + esc(m.material_result) + '</span>'
                              : '<span class="tag tag-red">No match</span>';
    html += '</div>';
    if (m.material_id) html += '<div class="step-detail">QFix ID: ' + m.material_id + '</div>';
    html += '</div></div>';

    // Step 3: Subcategory
    html += '<div class="step">';
    html += '<div class="step-num ok">3</div>';
    html += '<div class="step-body">';
    html += '<div class="step-label">Gender / Subcategory</div>';
    html += '<div class="step-value">' + esc(m.subcategory || 'Unknown') + '</div>';
    html += '</div></div>';

    // Step 4: URL
    const urlOk = m.qfix_url != null;
    html += '<div class="step">';
    html += '<div class="step-num ' + (urlOk ? 'ok' : 'fail') + '">4</div>';
    html += '<div class="step-body">';
    html += '<div class="step-label">QFix URL ' + (m.persisted ? '<span class="tag tag-gray">persisted</span>' : '<span class="tag tag-yellow">live</span>') + '</div>';
    if (urlOk) {
      html += '<div class="step-value"><a href="' + esc(m.qfix_url) + '" target="_blank" style="color:#1a1a1a; word-break:break-all;">' + esc(m.qfix_url) + '</a></div>';
    } else {
      html += '<div class="step-value"><span class="tag tag-red">No URL ‚Äî mapping incomplete</span></div>';
    }
    html += '</div></div>';

    // Persisted service URLs from DB
    const pUrls = data.persisted_service_urls || {};
    const hasPersistedUrls = pUrls.repair || pUrls.adjustment || pUrls.care || pUrls.other;

    if (hasPersistedUrls || svcs.length > 0) {
      html += '<h3 style="margin:20px 0 8px;">Service URLs</h3>';
      html += '<p style="font-size:13px; color:#666; margin-bottom:12px;">QFix booking URLs for each service type. These are persisted in the database and used by the redirect endpoints.</p>';

      const serviceRows = [
        {label: 'Repair', key: 'repair', dbUrl: pUrls.repair},
        {label: 'Adjustment', key: 'adjustment', dbUrl: pUrls.adjustment},
        {label: 'Care', key: 'care', dbUrl: pUrls.care},
        {label: 'Other', key: 'other', dbUrl: pUrls.other},
      ];

      html += '<table style="width:100%; border-collapse:collapse; font-size:14px; margin-bottom:12px;">';
      html += '<thead><tr><th style="text-align:left; padding:8px; border-bottom:2px solid #e0e0e0;">Service</th>';
      html += '<th style="text-align:left; padding:8px; border-bottom:2px solid #e0e0e0;">URL</th>';
      html += '<th style="text-align:left; padding:8px; border-bottom:2px solid #e0e0e0;">Status</th></tr></thead>';
      html += '<tbody>';
      for (const sr of serviceRows) {
        const url = sr.dbUrl;
        html += '<tr>';
        html += '<td style="padding:8px; border-bottom:1px solid #f0f0f0; font-weight:600;">' + esc(sr.label) + '</td>';
        if (url) {
          html += '<td style="padding:8px; border-bottom:1px solid #f0f0f0;"><a href="' + esc(url) + '" target="_blank" style="color:#1a1a1a; word-break:break-all; font-size:13px;">' + esc(url) + '</a></td>';
          html += '<td style="padding:8px; border-bottom:1px solid #f0f0f0;"><span class="tag tag-green">Persisted</span></td>';
        } else {
          html += '<td style="padding:8px; border-bottom:1px solid #f0f0f0; color:#aaa;">‚Äî</td>';
          html += '<td style="padding:8px; border-bottom:1px solid #f0f0f0;"><span class="tag tag-gray">Not available</span></td>';
        }
        html += '</tr>';
      }
      html += '</tbody></table>';

      // Quick-access buttons
      html += '<div class="service-links">';
      for (const sr of serviceRows) {
        if (sr.dbUrl) {
          html += '<a class="service-link" href="' + esc(sr.dbUrl) + '" target="_blank">' + esc(sr.label) + '</a>';
        } else {
          html += '<span class="service-link disabled">' + esc(sr.label) + '</span>';
        }
      }
      html += '</div>';
    }

    // Top suggested actions (AI-ranked)
    const topActions = data.top_actions || {};
    const hasActions = Object.values(topActions).some(function(a) { return a && a.length > 0; });

    if (hasActions) {
      html += '<h3 style="margin:20px 0 8px;">Suggested Actions</h3>';
      html += '<p style="font-size:13px; color:#666; margin-bottom:12px;">Top 5 most relevant service actions for this product type, ranked by AI.</p>';

      const actionLabels = {repair: 'Repair', adjustment: 'Adjustment', care: 'Washing & Care', other: 'Other'};
      for (const [key, label] of Object.entries(actionLabels)) {
        const actions = topActions[key];
        if (!actions || actions.length === 0) continue;
        html += '<div style="margin-bottom:12px;">';
        html += '<div style="font-size:13px; font-weight:700; color:#555; margin-bottom:4px;">' + esc(label) + '</div>';
        html += '<div style="display:flex; flex-wrap:wrap; gap:6px;">';
        for (const a of actions) {
          const priceStr = a.price ? ' ‚Äî from ' + a.price + ' kr' : '';
          html += '<span style="display:inline-block; padding:5px 12px; background:#f0f0f0; border-radius:16px; font-size:13px;">';
          html += esc(a.name) + '<span style="color:#888;">' + esc(priceStr) + '</span></span>';
        }
        html += '</div></div>';
      }
    }

    el.innerHTML = html;
  } catch (e) {
    el.innerHTML = '<div class="error-msg">Request failed: ' + esc(e.message) + '</div>';
  }
}

// Allow Enter key
document.getElementById('productId').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') verify();
});

// URL param support
(function() {
  const params = new URLSearchParams(location.search);
  const pid = params.get('productId') || params.get('product_id');
  if (pid) {
    document.getElementById('productId').value = pid;
    verify();
  }
})();

function esc(s) {
  if (s == null) return '';
  const d = document.createElement('div');
  d.textContent = String(s);
  return d.innerHTML;
}

// Load coverage stats
async function loadCoverage() {
  try {
    const res = await fetch('/remap/status');
    const data = await res.json();
    const tbody = document.getElementById('coverageBody');
    if (!data.length) { tbody.innerHTML = '<tr><td colspan="5" style="color:#aaa;">No data</td></tr>'; return; }
    data.sort((a, b) => b.total - a.total);
    tbody.innerHTML = data.map(function(r) {
      const pct = r.total > 0 ? Math.round(100 * r.mapped / r.total) : 0;
      const color = pct >= 80 ? '#22c55e' : pct >= 50 ? '#eab308' : '#ef4444';
      return '<tr><td><strong>' + esc(r.brand) + '</strong></td><td>' + r.total + '</td><td>' + r.mapped + '</td><td>' + r.unmapped + '</td>'
        + '<td><div style="display:flex;align-items:center;gap:8px;"><div class="coverage-bar"><div class="coverage-fill" style="width:' + pct + '%;background:' + color + '"></div></div><span style="font-size:13px;font-weight:600;">' + pct + '%</span></div></td></tr>';
    }).join('');
  } catch (e) {
    document.getElementById('coverageBody').innerHTML = '<tr><td colspan="5" class="error-msg">Failed to load</td></tr>';
  }
}
loadCoverage();

// Load mapping reference tables
async function loadMappingTables() {
  try {
    const res = await fetch('/unmapped');
    const data = await res.json();

    // QFix clothing types
    const types = data.qfix_valid_clothing_types || {};
    const tbody1 = document.getElementById('clothingTypesBody');
    tbody1.innerHTML = Object.entries(types).sort((a,b) => a[0].localeCompare(b[0])).map(function(e) {
      return '<tr><td>' + esc(e[0]) + '</td><td>' + e[1] + '</td></tr>';
    }).join('');
  } catch (e) {}
}
loadMappingTables();

// Load clothing type and material mapping tables
async function loadFullMappings() {
  try {
    const res = await fetch('/docs/mappings');
    const data = await res.json();

    const cmBody = document.getElementById('clothingMapBody');
    const entries = Object.entries(data.clothing_type_map || {});
    cmBody.innerHTML = entries.map(function(e) {
      return '<tr><td><span class="cat-link" onclick="showCategoryProducts(\'' + esc(e[0]).replace(/'/g, "\\'") + '\',\'' + esc(e[1]).replace(/'/g, "\\'") + '\')">' + esc(e[0]) + '</span></td><td><span class="tag tag-green">' + esc(e[1]) + '</span></td></tr>';
    }).join('');

    const mmBody = document.getElementById('materialMapBody');
    const mEntries = Object.entries(data.material_map || {});
    mmBody.innerHTML = mEntries.map(function(e) {
      return '<tr><td>' + esc(e[0]) + '</td><td><span class="tag tag-green">' + esc(e[1]) + '</span></td></tr>';
    }).join('');
  } catch (e) {
    document.getElementById('clothingMapBody').innerHTML = '<tr><td colspan="2" class="error-msg">Failed to load</td></tr>';
    document.getElementById('materialMapBody').innerHTML = '<tr><td colspan="2" class="error-msg">Failed to load</td></tr>';
  }
}
loadFullMappings();

// Load AI-ranked actions
async function loadRankings() {
  try {
    const res = await fetch('/docs/rankings');
    const data = await res.json();

    // Group by clothing type
    const groups = {};
    for (const item of data) {
      const key = item.clothing_type_id;
      if (!groups[key]) {
        groups[key] = { name: item.clothing_type_name, id: item.clothing_type_id, materials: [] };
      }
      groups[key].materials.push(item);
    }

    const svcLabels = {repair: 'Repair', adjustment: 'Adjustment', care: 'Washing & Care', other: 'Other'};
    const container = document.getElementById('rankingsContainer');
    const allGroups = Object.values(groups).sort((a, b) => a.name.localeCompare(b.name));

    function renderGroups(filter) {
      const lf = (filter || '').toLowerCase();
      let html = '';
      let shown = 0;
      for (const g of allGroups) {
        const matchesGroup = !lf || g.name.toLowerCase().includes(lf);
        const matchingMats = g.materials.filter(function(m) {
          return matchesGroup || m.material_name.toLowerCase().includes(lf);
        });
        if (matchingMats.length === 0) continue;
        shown++;

        html += '<div class="ranking-group">';
        html += '<div class="ranking-header" onclick="this.classList.toggle(\'open\');this.nextElementSibling.classList.toggle(\'open\')">';
        html += '<h4>' + esc(g.name) + ' <span style="color:#aaa; font-weight:400;">(ID ' + g.id + ')</span></h4>';
        html += '<span><span class="rh-meta">' + matchingMats.length + ' material' + (matchingMats.length !== 1 ? 's' : '') + '</span> <span class="rh-arrow">&#9654;</span></span>';
        html += '</div>';
        html += '<div class="ranking-body">';

        for (const m of matchingMats) {
          html += '<div class="ranking-material">';
          html += '<div class="ranking-material-label">' + esc(m.material_name) + ' (ID ' + m.material_id + ')</div>';
          const r = m.rankings || {};
          for (const [svcKey, svcLabel] of Object.entries(svcLabels)) {
            const actions = r[svcKey];
            if (!actions || actions.length === 0) continue;
            html += '<div class="ranking-svc">';
            html += '<div class="ranking-svc-label">' + esc(svcLabel) + '</div>';
            html += '<div class="ranking-pills">';
            for (const a of actions) {
              const price = a.price ? ' ' + a.price + ' kr' : '';
              html += '<span class="ranking-pill">';
              html += esc(a.name);
              if (price) html += ' <span class="ranking-pill-price">' + esc(price) + '</span>';
              html += ' <span class="ranking-pill-id">#' + a.id + '</span>';
              html += '</span>';
            }
            html += '</div></div>';
          }
          html += '</div>';
        }

        html += '</div></div>';
      }

      if (shown === 0) {
        html = '<p style="color:#aaa; padding:8px;">No matches found.</p>';
      }
      container.innerHTML = html;
    }

    renderGroups('');

    document.getElementById('rankingsFilter').addEventListener('input', function() {
      renderGroups(this.value);
    });
  } catch (e) {
    document.getElementById('rankingsContainer').innerHTML = '<p class="error-msg">Failed to load rankings</p>';
  }
}
loadRankings();

// Load unmapped categories per brand
async function loadUnmappedCategories() {
  try {
    const res = await fetch('/remap/unmapped-categories');
    const data = await res.json();
    const container = document.getElementById('unmappedCategoriesContainer');

    // Group by brand
    const brands = {};
    let grandTotal = 0;
    for (const row of data) {
      if (!brands[row.brand]) brands[row.brand] = [];
      brands[row.brand].push(row);
      grandTotal += row.cnt;
    }

    let html = '<p style="color:#1a1a1a; margin-bottom:12px;"><strong>' + grandTotal + '</strong> products across ' + Object.keys(brands).length + ' brands have no QFix mapping.</p>';

    for (const brand of Object.keys(brands).sort()) {
      const rows = brands[brand];
      const brandTotal = rows.reduce(function(s, r) { return s + r.cnt; }, 0);
      html += '<h4 style="margin:12px 0 4px; font-size:13px;">' + esc(brand) + ' <span style="color:#999;">(' + brandTotal + ' products)</span></h4>';
      html += '<table class="map-table"><thead><tr><th>Category</th><th>Count</th><th>Sample product</th></tr></thead><tbody>';
      for (const r of rows) {
        html += '<tr>';
        html += '<td>' + esc(r.clothing_type) + '</td>';
        html += '<td style="text-align:center;">' + r.cnt + '</td>';
        html += '<td style="color:#666;">' + esc(r.sample_product_name || '') + '</td>';
        html += '</tr>';
      }
      html += '</tbody></table>';
    }

    container.innerHTML = html;
  } catch (e) {
    document.getElementById('unmappedCategoriesContainer').innerHTML = '<p class="error-msg">Failed to load unmapped categories</p>';
  }
}
loadUnmappedCategories();

// Load missing services
async function loadMissingServices() {
  try {
    const res = await fetch('/docs/missing-services');
    const data = await res.json();
    const container = document.getElementById('missingServicesContainer');

    let html = '<p style="color:#1a1a1a; margin-bottom:12px;"><strong>' + data.total_types_missing + '</strong> clothing types (' + data.total_combos_missing + ' type/material combos) have no services defined.</p>';
    html += '<table class="map-table"><thead><tr><th>Clothing Type</th><th>ID</th><th>Parent Category</th><th>Materials</th></tr></thead><tbody>';

    for (const t of data.types) {
      const mats = t.materials.map(function(m) { return m.material_name; }).join(', ');
      html += '<tr>';
      html += '<td>' + esc(t.clothing_type_name) + '</td>';
      html += '<td>' + t.clothing_type_id + '</td>';
      html += '<td>' + esc(t.parent_category) + '</td>';
      html += '<td>' + esc(mats) + '</td>';
      html += '</tr>';
    }

    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (e) {
    document.getElementById('missingServicesContainer').innerHTML = '<p class="error-msg">Failed to load missing services</p>';
  }
}
loadMissingServices();

// Load keyword injection stats
async function loadKeywordStats() {
  try {
    const res = await fetch('/docs/keyword-stats');
    const data = await res.json();
    const container = document.getElementById('keywordStatsTable');

    let html = '<table style="border-collapse:collapse; width:100%;">';
    html += '<thead><tr style="background:#f8f9fa;">';
    html += '<th style="text-align:left; padding:4px 8px; border-bottom:2px solid #e0e0e0;">Keyword (SV/EN)</th>';
    html += '<th style="text-align:left; padding:4px 8px; border-bottom:2px solid #e0e0e0;">Injected Actions</th>';
    html += '<th style="text-align:left; padding:4px 8px; border-bottom:2px solid #e0e0e0;">Category</th>';
    html += '<th style="text-align:right; padding:4px 8px; border-bottom:2px solid #e0e0e0;">Products</th>';
    html += '</tr></thead><tbody>';

    for (const rule of data.rules) {
      const pct = data.total_products > 0 ? (rule.product_count / data.total_products * 100).toFixed(1) : '0';
      html += '<tr>';
      html += '<td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">' + esc(rule.keywords.join(', ')) + '</td>';
      html += '<td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;">' + esc(rule.actions.join(', ')) + '</td>';
      html += '<td style="padding:3px 8px; border-bottom:1px solid #f0f0f0;"><span class="tag tag-green">' + esc(rule.category) + '</span></td>';
      html += '<td style="padding:3px 8px; border-bottom:1px solid #f0f0f0; text-align:right;">';
      html += '<strong>' + rule.product_count + '</strong> <span style="color:#aaa;">(' + pct + '%)</span>';
      html += '</td></tr>';
    }

    html += '</tbody></table>';
    html += '<p style="margin-top:6px; color:#888;">Out of ' + data.total_products.toLocaleString() + ' total products in the database.</p>';
    container.innerHTML = html;
  } catch (e) {
    document.getElementById('keywordStatsTable').innerHTML = '<p class="error-msg">Failed to load keyword stats</p>';
  }
}
loadKeywordStats();

// Category drilldown
async function showCategoryProducts(category, qfixType) {
  const overlay = document.getElementById('drilldownOverlay');
  const modal = document.getElementById('drilldownModal');
  modal.innerHTML = '<p style="color:#aaa;">Loading products for "' + esc(category) + '"...</p>';
  overlay.classList.add('open');

  try {
    const res = await fetch('/docs/category-products?category=' + encodeURIComponent(category) + '&limit=30');
    const data = await res.json();

    let html = '<button class="drilldown-close" onclick="closeDrilldown()">&times;</button>';
    html += '<h3>Products matching "' + esc(category) + '"</h3>';
    html += '<p class="dm-sub">Mapped to <span class="tag tag-green">' + esc(qfixType) + '</span> &mdash; ' + data.count + ' products found</p>';

    if (data.count === 0) {
      html += '<p style="color:#888;">No products in the database have this category.</p>';
    } else {
      html += '<table class="map-table"><thead><tr><th>Brand</th><th>Product ID</th><th>Product</th><th>Category (brand)</th><th>Clothing Type (brand)</th><th>Material</th><th>QFix Mapping</th></tr></thead><tbody>';
      for (const p of data.products) {
        const qfix = p.qfix_clothing_type ? esc(p.qfix_clothing_type) + ' / ' + esc(p.qfix_material || '?') : '<span style="color:#aaa;">unmapped</span>';
        html += '<tr>';
        html += '<td>' + esc(p.brand || '') + '</td>';
        html += '<td>' + esc(p.product_id || '') + '</td>';
        html += '<td>' + esc(p.product_name || '') + '</td>';
        html += '<td>' + esc(p.category || '') + '</td>';
        html += '<td>' + esc(p.clothing_type || '') + '</td>';
        html += '<td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="' + esc(p.material_composition || '') + '">' + esc(p.material_composition || '') + '</td>';
        html += '<td>' + qfix + '</td>';
        html += '</tr>';
      }
      html += '</tbody></table>';
    }

    modal.innerHTML = html;
  } catch (e) {
    modal.innerHTML = '<button class="drilldown-close" onclick="closeDrilldown()">&times;</button><p class="error-msg">Failed to load products</p>';
  }
}

function closeDrilldown() {
  document.getElementById('drilldownOverlay').classList.remove('open');
}
</script>

<div class="drilldown-overlay" id="drilldownOverlay" onclick="if(event.target===this)closeDrilldown()">
  <div class="drilldown-modal" id="drilldownModal"></div>
</div>

</body>
</html>
